<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Keen Daily Machine Report - Archive System</title>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            background-attachment: fixed;
            color: #f1f5f9;
            line-height: 1.5;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* Archive Mode Banner */
        .archive-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .archive-banner.show { display: flex; }
        .archive-banner button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .connection-status.online { background: rgba(16, 185, 129, 0.9); color: white; }
        .connection-status.offline { background: rgba(239, 68, 68, 0.9); color: white; }

        .sync-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 20px;
            z-index: 9998;
        }

        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, rgba(99,102,241,0.2) 0%, transparent 70%);
            padding: 20px;
        }
        
        .glass-card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            max-width: 400px;
            width: 100%;
            padding: 40px;
        }

        .login-header { text-align: center; margin-bottom: 32px; }
        .logo i { font-size: 60px; color: #fbbf24; }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; }
        .modern-input {
            width: 100%; padding: 12px 16px;
            background: rgba(15,23,42,0.6);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px; color: white; font-size: 16px;
        }

        .btn {
            padding: 14px 24px; border: none; border-radius: 10px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; width: 100%; touch-action: manipulation;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-danger { background: rgba(239,68,68,0.2); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
        .btn-success { background: rgba(16,185,129,0.2); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }
        .btn-accent { background: rgba(139,92,246,0.2); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.3); }
        .btn-warning { background: rgba(245,158,11,0.2); color: #fbbf24; border: 1px solid rgba(245,158,11,0.3); }

        .btn-sm { padding: 8px 14px; font-size: 13px; border-radius: 8px; width: auto; flex: 1; max-width: 100px; }

        .app-container { max-width: 1400px; margin: 0 auto; padding: 20px; padding-bottom: 100px; display: none; }
        
        .modern-header {
            display: flex; flex-direction: column; gap: 12px;
            background: rgba(30,41,59,0.8);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px; padding: 16px; margin-bottom: 20px;
        }
        @media(min-width: 768px) { .modern-header { flex-direction: row; justify-content: space-between; align-items: center; } }

        .brand-logo {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white;
        }
        .brand-text h1 { font-size: 20px; font-weight: 800; color: white; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .keen-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; color: white; }

        .session-info {
            display: flex; align-items: center; justify-content: space-between; gap: 12px;
            background: rgba(255,255,255,0.05); padding: 10px 16px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar-icon { font-size: 24px; color: #6366f1; }
        .user-name { font-weight: 600; font-size: 14px; color: white; }
        .role-tag { font-size: 11px; color: #94a3b8; text-transform: uppercase; }
        
        .btn-logout {
            width: 36px; height: 36px; border-radius: 10px; border: none;
            background: rgba(239,68,68,0.2); color: #f87171; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        .stats-row {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;
        }
        @media(min-width: 768px) { .stats-row { grid-template-columns: repeat(4, 1fr); } }

        .stat-card {
            background: rgba(30,41,59,0.8); border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px;
        }
        .stat-icon-box {
            width: 48px; height: 48px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
        }
        .stat-pending .stat-icon-box { background: linear-gradient(135deg, rgba(239,68,68,0.3) 0%, rgba(239,68,68,0.1) 100%); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
        .stat-sent .stat-icon-box { background: linear-gradient(135deg, rgba(16,185,129,0.3) 0%, rgba(16,185,129,0.1) 100%); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }
        .stat-notfound .stat-icon-box { background: linear-gradient(135deg, rgba(245,158,11,0.3) 0%, rgba(245,158,11,0.1) 100%); color: #fbbf24; border: 1px solid rgba(245,158,11,0.3); }
        .stat-received .stat-icon-box { background: linear-gradient(135deg, rgba(99,102,241,0.3) 0%, rgba(99,102,241,0.1) 100%); color: #a5b4fc; border: 1px solid rgba(99,102,241,0.3); }

        .stat-number { font-size: 24px; font-weight: 800; color: white; }
        .stat-label { font-size: 12px; color: #94a3b8; }

        .input-panel {
            background: linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(139,92,246,0.05) 100%);
            border: 1px solid rgba(255,255,255,0.12); border-radius: 16px;
            padding: 20px; margin-bottom: 20px;
        }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .panel-header h3 { font-size: 16px; color: white; display: flex; align-items: center; gap: 8px; }
        .badge-manager { background: rgba(99,102,241,0.2); color: #a5b4fc; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .panel-desc { color: #94a3b8; margin-bottom: 12px; font-size: 13px; }
        
        textarea {
            width: 100%; min-height: 80px; padding: 12px;
            background: rgba(15,23,42,0.5); border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px; color: white; font-family: 'Courier New', monospace;
            font-size: 14px; margin-bottom: 12px; resize: vertical;
        }

        .input-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .input-actions .btn { width: auto; flex: 1; min-width: 120px; }

        .toolbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .toolbar .btn { flex: 1; min-width: auto; max-width: 100px; }

        .table-wrap {
            background: rgba(30,41,59,0.8); border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px; overflow: hidden; overflow-x: auto;
        }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 900px; }
        thead { background: rgba(99,102,241,0.1); }
        th { padding: 10px 8px; text-align: left; font-weight: 600; color: #a5b4fc; font-size: 10px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); }
        td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #f1f5f9; vertical-align: middle; }
        
        .input-cell {
            width: 100%; background: transparent; border: 1px solid transparent;
            padding: 6px; color: white; border-radius: 6px; font-family: inherit; font-size: 12px;
        }
        .input-cell:focus { outline: none; background: rgba(255,255,255,0.1); border-color: #6366f1; }
        
        select.input-cell {
            background-color: #1e293b !important; color: #f1f5f9 !important;
            appearance: none; -webkit-appearance: none; padding-right: 24px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f1f5f9' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 6px center;
            cursor: pointer; font-weight: 600;
        }

        .date-cell { font-size: 11px; color: #94a3b8; white-space: nowrap; min-width: 120px; }

        .empty-state { text-align: center; padding: 40px; color: #64748b; }

        tr.status-pending { background: rgba(239,68,68,0.08); }
        tr.status-sent { background: rgba(16,185,129,0.08); }
        tr.status-notfound { background: rgba(245,158,11,0.08); }
        tr.status-received { background: rgba(99,102,241,0.08); }

        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
            overflow-y: auto; padding: 20px;
        }
        .modal-content {
            max-width: 500px; margin: 40px auto; padding: 24px;
            background: rgba(30,41,59,0.95); border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px; position: relative;
        }
        .close-btn {
            position: absolute; top: 16px; right: 16px;
            background: rgba(255,255,255,0.1); border: none; color: #94a3b8;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px;
        }

        .history-list { max-height: 300px; overflow-y: auto; margin-top: 16px; }
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: rgba(255,255,255,0.05);
            border-radius: 8px; margin-bottom: 8px; cursor: pointer;
            transition: all 0.2s;
        }
        .history-item:hover { background: rgba(255,255,255,0.1); }
        .history-item.selected { border: 2px solid #6366f1; }

        .confirm-input {
            width: 100%; padding: 12px; margin: 12px 0;
            background: rgba(15,23,42,0.6); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; color: white; font-size: 16px; text-align: center;
            letter-spacing: 2px;
        }

        .footer-bar { text-align: center; margin-top: 20px; color: #64748b; font-size: 13px; }
    </style>
</head>
<body>

    <!-- Archive Mode Banner -->
    <div id="archiveBanner" class="archive-banner">
        <i class="fas fa-archive"></i>
        <span>Viewing Archive: <strong id="archiveDate">-</strong></span>
        <button onclick="app.returnToCurrent()">
            <i class="fas fa-arrow-left"></i> Back to Current
        </button>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status offline">
        <i class="fas fa-wifi"></i>
        <span id="connectionText">Connecting...</span>
    </div>

    <!-- Sync Button -->
    <button class="sync-badge" onclick="app.forceSync()" title="Force Sync">
        <i class="fas fa-sync-alt"></i>
    </button>

    <!-- LOGIN SCREEN -->
    <div id="loginModal" class="login-screen">
        <div class="glass-card">
            <div class="login-header">
                <div class="logo"><i class="fas fa-tractor"></i></div>
                <h2 style="color: white; margin-bottom: 8px;">Keen Daily Report</h2>
                <p style="color: #94a3b8; font-size: 14px;">Machine Tracking System</p>
            </div>
            
            <div class="login-form">
                <div class="input-group">
                    <label>User</label>
                    <select id="loginEmail" class="modern-input">
                        <option value="">Select user...</option>
                        <option value="manager@cat.com">ðŸ‘‘ Manager</option>
                        <option value="tech@cat.com">ðŸ”§ Technician</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="modern-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                
                <button onclick="app.login()" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Access System
                </button>
                
                <div id="loginError" class="error-message"></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container" id="mainContainer">
        <header class="modern-header">
            <div class="header-left">
                <div class="brand-logo"><i class="fas fa-clipboard-list"></i></div>
                <div>
                    <h1>Keen Daily <span class="keen-badge">PRO</span></h1>
                    <div class="header-subtitle" id="viewModeSubtitle">Live Status Monitoring</div>
                </div>
            </div>
            
            <div class="session-info">
                <div class="user-info">
                    <div class="avatar-icon"><i class="fas fa-user-circle"></i></div>
                    <div class="user-text">
                        <span id="currentUser" class="user-name">-</span>
                        <span id="userRole" class="role-tag">-</span>
                    </div>
                </div>
                <button onclick="app.logout()" class="btn-logout"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <div class="stats-row">
            <div class="stat-card stat-pending">
                <div class="stat-icon-box"><i class="fas fa-hourglass-start"></i></div>
                <div class="stat-info">
                    <span class="stat-number" id="statPending">0</span>
                    <span class="stat-label">Pending</span>
                </div>
            </div>
            <div class="stat-card stat-sent">
                <div class="stat-icon-box"><i class="fas fa-truck-loading"></i></div>
                <div class="stat-info">
                    <span class="stat-number" id="statSent">0</span>
                    <span class="stat-label">Sent to Keen</span>
                </div>
            </div>
            <div class="stat-card stat-notfound">
                <div class="stat-icon-box"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-info">
                    <span class="stat-number" id="statNotFound">0</span>
                    <span class="stat-label">Not Found</span>
                </div>
            </div>
            <div class="stat-card stat-received">
                <div class="stat-icon-box"><i class="fas fa-check-double"></i></div>
                <div class="stat-info">
                    <span class="stat-number" id="statReceived">0</span>
                    <span class="stat-label">Received</span>
                </div>
            </div>
        </div>

        <div id="inputSection" class="input-panel" style="display: none;">
            <div class="panel-header">
                <h3><i class="fas fa-plus-circle"></i> Bulk Entry</h3>
                <span class="badge-manager">Manager</span>
            </div>
            <p class="panel-desc">Paste VINs (one per line)</p>
            <textarea id="batchVins" placeholder="CAT00275CR8Y05091..."></textarea>
            <div class="input-actions">
                <button onclick="app.addVinBulk()" class="btn btn-primary"><i class="fas fa-plus"></i> Add</button>
                <button onclick="app.showArchiveModal()" class="btn btn-warning"><i class="fas fa-archive"></i> Archive Day</button>
                <button onclick="app.showHistoryModal()" class="btn btn-secondary"><i class="fas fa-history"></i> History</button>
            </div>
        </div>

        <!-- NUEVO: Panel para Technician con acceso a History -->
        <div id="techPanel" class="input-panel" style="display: none;">
            <div class="panel-header">
                <h3><i class="fas fa-tools"></i> Technician Tools</h3>
                <span class="badge-manager" style="background: rgba(16,185,129,0.2); color: #34d399;">Tech</span>
            </div>
            <p class="panel-desc">View archives and system history</p>
            <div class="input-actions">
                <button onclick="app.showHistoryModal()" class="btn btn-secondary"><i class="fas fa-history"></i> View History</button>
            </div>
        </div>

        <div class="toolbar">
            <button onclick="app.generateReport()" class="btn btn-accent btn-sm"><i class="fas fa-chart-pie"></i> Report</button>
            <button onclick="app.exportExcel()" class="btn btn-success btn-sm"><i class="fas fa-file-excel"></i> Excel</button>
            <button onclick="app.exportPDF()" class="btn btn-danger btn-sm"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>

        <div class="table-wrap">
            <table id="reportTable">
                <thead>
                    <tr>
                        <th>VIN</th>
                        <th>Machine</th>
                        <th>Parking</th>
                        <th>Update</th>
                        <th>Keen</th>
                        <th>Date</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr class="empty-state">
                        <td colspan="7" style="padding: 40px;">
                            <i class="fas fa-spinner fa-spin" style="display: block; margin-bottom: 12px;"></i>
                            Connecting to Firebase...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="footer-bar">
            <span id="lastUpdate">Initializing...</span>
        </div>
    </div>

    <!-- ARCHIVE CONFIRMATION MODAL -->
    <div id="archiveModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="app.closeModal('archiveModal')"><i class="fas fa-times"></i></button>
            <h2 style="color: #fbbf24; margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i> Archive Current Day</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                This will move all <strong id="archiveCount">0</strong> current records to the archive. 
                They will be preserved and accessible via History.
            </p>
            <div style="background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <p style="color: #f87171; font-size: 14px; margin-bottom: 10px;">
                    <i class="fas fa-shield-alt"></i> Security Confirmation Required
                </p>
                <p style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">
                    Type <strong>ARCHIVE</strong> to confirm:
                </p>
                <input type="text" id="archiveConfirmInput" class="confirm-input" placeholder="TYPE ARCHIVE" autocomplete="off">
            </div>
            <button onclick="app.executeArchive()" class="btn btn-warning" id="archiveBtn" disabled>
                <i class="fas fa-archive"></i> Confirm Archive
            </button>
        </div>
    </div>

    <!-- HISTORY VIEWER MODAL -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-btn" onclick="app.closeModal('historyModal')"><i class="fas fa-times"></i></button>
            <h2 style="color: #a5b4fc; margin-bottom: 16px;"><i class="fas fa-history"></i> View History</h2>
            <p style="color: #94a3b8; margin-bottom: 16px;">Select a date to view archived records:</p>
            <div id="historyList" class="history-list">
                <div class="empty-state" style="padding: 20px;">
                    <i class="fas fa-spinner fa-spin"></i> Loading archives...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - ACTUALIZADO CON NUEVOS DATOS
        const firebaseConfig = {
            apiKey: "AIzaSyBRVKFQoXEEAeaHVGMNnJBghUd7SMj1wXM",
            authDomain: "keen-daily-report-e795a.firebaseapp.com",
            databaseURL: "https://keen-daily-report-e795a-default-rtdb.firebaseio.com",
            projectId: "keen-daily-report-e795a",
            storageBucket: "keen-daily-report-e795a.firebasestorage.app",
            messagingSenderId: "583466443123",
            appId: "1:583466443123:web:4c453db13dab9007e8a506"
        };

        let database, currentRef, historyRef;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            currentRef = database.ref('vins/current');
            historyRef = database.ref('vins/history');
        } catch(e) {
            console.error("Firebase init error:", e);
            alert("Error initializing database: " + e.message);
        }

        const app = {
            data: [],
            currentUser: null,
            userRole: null,
            chart: null,
            isOnline: false,
            isArchiveView: false,
            currentArchiveDate: null,
            
            credentials: {
                'manager@cat.com': { password: 'admin123', role: 'manager' },
                'tech@cat.com': { password: 'tech123', role: 'tech' }
            },

            init() {
                this.setupConnectionMonitoring();
                this.setupArchiveInput();
                
                const session = localStorage.getItem('keen_report_session');
                if (session) {
                    const data = JSON.parse(session);
                    this.currentUser = data.email;
                    this.userRole = data.role;
                    this.showMainInterface();
                }
            },

            setupConnectionMonitoring() {
                if (!database) return;
                
                database.ref(".info/connected").on("value", (snap) => {
                    const isConnected = snap.val() === true;
                    this.isOnline = isConnected;
                    this.updateConnectionUI(isConnected);
                    if (isConnected && this.currentUser) this.loadData();
                });

                window.addEventListener('online', () => {
                    this.isOnline = true;
                    database.goOnline();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateConnectionUI(false);
                });
            },

            updateConnectionUI(connected) {
                const statusEl = document.getElementById('connectionStatus');
                const statusText = document.getElementById('connectionText');
                if (connected) {
                    statusEl.className = 'connection-status online';
                    statusText.textContent = 'Live';
                } else {
                    statusEl.className = 'connection-status offline';
                    statusText.textContent = 'Offline';
                }
            },

            setupArchiveInput() {
                const input = document.getElementById('archiveConfirmInput');
                if (input) {
                    input.addEventListener('input', (e) => {
                        const btn = document.getElementById('archiveBtn');
                        btn.disabled = e.target.value !== 'ARCHIVE';
                    });
                }
            },

            login() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');
                
                if (!email || !password) {
                    errorDiv.textContent = 'Enter credentials';
                    return;
                }
                
                const user = this.credentials[email];
                if (!user || user.password !== password) {
                    errorDiv.textContent = 'Invalid credentials';
                    return;
                }
                
                this.currentUser = email;
                this.userRole = user.role;
                
                localStorage.setItem('keen_report_session', JSON.stringify({
                    email: email,
                    role: user.role
                }));
                
                this.showMainInterface();
            },

            logout() {
                if (confirm('Logout?')) {
                    localStorage.removeItem('keen_report_session');
                    location.reload();
                }
            },

            showMainInterface() {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                
                document.getElementById('currentUser').textContent = this.currentUser;
                document.getElementById('userRole').textContent = this.userRole;

                // CORREGIDO: Mostrar panel segÃºn rol
                if (this.userRole === 'manager') {
                    document.getElementById('inputSection').style.display = 'block';
                    document.getElementById('techPanel').style.display = 'none';
                } else {
                    // Tech user: ocultar inputSection (bulk entry), mostrar techPanel
                    document.getElementById('inputSection').style.display = 'none';
                    document.getElementById('techPanel').style.display = 'block';
                }
                
                this.loadData();
            },

            loadData() {
                if (!currentRef) return;

                document.getElementById('lastUpdate').textContent = "Loading...";
                
                // Remove old listeners
                currentRef.off();
                
                const targetRef = this.isArchiveView && this.currentArchiveDate 
                    ? historyRef.child(this.currentArchiveDate)
                    : currentRef;
                
                targetRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const dataObj = snapshot.val();
                        this.data = Object.keys(dataObj).map(key => ({
                            firebaseId: key,
                            ...dataObj[key]
                        })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    } else {
                        this.data = [];
                    }
                    
                    this.render();
                    const time = new Date().toLocaleTimeString();
                    document.getElementById('lastUpdate').textContent = 
                        this.isOnline ? `Sync: ${time}` : `Offline (${time})`;
                });
            },

            render() {
                const stats = { pending: 0, sent: 0, notfound: 0, received: 0, total: this.data.length };
                const tbody = document.getElementById('tableBody');
                
                if (this.data.length === 0) {
                    tbody.innerHTML = `
                        <tr class="empty-state">
                            <td colspan="7" style="padding: 40px;">
                                <i class="fas fa-inbox" style="font-size: 40px; display: block; margin-bottom: 10px;"></i>
                                ${this.isArchiveView ? 'No data for this date' : 'No data yet'}
                            </td>
                        </tr>
                    `;
                } else {
                    tbody.innerHTML = '';
                    this.data.forEach((row) => {
                        if (row.statusParking === 'Pending') stats.pending++;
                        else if (row.statusParking === 'Sent') stats.sent++;
                        else if (row.statusParking === 'Not Found') stats.notfound++;
                        if (row.statusKeen === 'Received') stats.received++;

                        const tr = document.createElement('tr');
                        if (row.statusKeen === 'Received') tr.className = 'status-received';
                        else if (row.statusParking === 'Pending') tr.className = 'status-pending';
                        else if (row.statusParking === 'Sent') tr.className = 'status-sent';
                        else if (row.statusParking === 'Not Found') tr.className = 'status-notfound';

                        // CORREGIDO: Permitir ediciÃ³n a manager Y tech, excepto en vista de archivo
                        const isReadOnly = this.isArchiveView; // Solo readonly si es archivo
                        const disabled = isReadOnly ? 'disabled' : '';

                        tr.innerHTML = `
                            <td><strong>${row.vin}</strong></td>
                            <td>${row.machine || '-'}</td>
                            <td>
                                <select class="input-cell" onchange="app.updateStatus('${row.firebaseId}', 'parking', this.value)" ${disabled}>
                                    <option value="Pending" ${(row.statusParking === 'Pending' || !row.statusParking) ? 'selected' : ''}>Pending</option>
                                    <option value="Sent" ${row.statusParking === 'Sent' ? 'selected' : ''}>Sent</option>
                                    <option value="Not Found" ${row.statusParking === 'Not Found' ? 'selected' : ''}>Not Found</option>
                                </select>
                            </td>
                            <td class="date-cell">${row.parkingUpdateDate || '-'}</td>
                            <td>
                                <select class="input-cell" onchange="app.updateStatus('${row.firebaseId}', 'keen', this.value)" ${disabled}>
                                    <option value="Not received" ${(row.statusKeen === 'Not received' || !row.statusKeen) ? 'selected' : ''}>Not received</option>
                                    <option value="Received" ${row.statusKeen === 'Received' ? 'selected' : ''}>Received</option>
                                </select>
                            </td>
                            <td class="date-cell">${row.keenDate || '-'}</td>
                            <td>
                                <input type="text" class="input-cell" value="${row.comments || ''}" 
                                       onchange="app.updateComment('${row.firebaseId}', this.value)" 
                                       placeholder="..." ${disabled}>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                document.getElementById('statPending').textContent = stats.pending;
                document.getElementById('statSent').textContent = stats.sent;
                document.getElementById('statNotFound').textContent = stats.notfound;
                document.getElementById('statReceived').textContent = stats.received;
            },

            // ARCHIVE SYSTEM
            showArchiveModal() {
                // Solo manager puede archivar
                if (this.userRole !== 'manager') {
                    alert('Only managers can archive data');
                    return;
                }
                if (!this.isOnline) {
                    alert('You are offline');
                    return;
                }
                document.getElementById('archiveCount').textContent = this.data.length;
                document.getElementById('archiveConfirmInput').value = '';
                document.getElementById('archiveBtn').disabled = true;
                document.getElementById('archiveModal').style.display = 'block';
            },

            showHistoryModal() {
                document.getElementById('historyModal').style.display = 'block';
                this.loadHistoryList();
            },

            loadHistoryList() {
                const listDiv = document.getElementById('historyList');
                listDiv.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
                
                historyRef.once('value').then((snapshot) => {
                    if (!snapshot.exists()) {
                        listDiv.innerHTML = '<div class="empty-state">No archives yet</div>';
                        return;
                    }
                    
                    const dates = Object.keys(snapshot.val()).sort().reverse();
                    listDiv.innerHTML = '';
                    
                    dates.forEach(date => {
                        const count = Object.keys(snapshot.val()[date]).length;
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        item.innerHTML = `
                            <div>
                                <i class="fas fa-calendar-alt" style="color: #6366f1; margin-right: 8px;"></i>
                                <strong>${date}</strong>
                                <span style="color: #94a3b8; margin-left: 8px;">(${count} records)</span>
                            </div>
                            <i class="fas fa-chevron-right" style="color: #64748b;"></i>
                        `;
                        item.onclick = () => this.viewArchive(date);
                        listDiv.appendChild(item);
                    });
                });
            },

            executeArchive() {
                const input = document.getElementById('archiveConfirmInput').value;
                if (input !== 'ARCHIVE') return;
                
                if (this.data.length === 0) {
                    alert('No data to archive');
                    return;
                }

                const dateStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const archiveTarget = historyRef.child(dateStr);
                
                // First, export to Excel automatically as backup
                this.exportExcel(true);
                
                // Move data to archive
                const updates = {};
                this.data.forEach(row => {
                    updates[row.firebaseId] = row;
                });
                
                archiveTarget.set(updates).then(() => {
                    // Clear current after successful archive
                    return currentRef.remove();
                }).then(() => {
                    this.closeModal('archiveModal');
                    this.showToast(`Archived ${this.data.length} records to ${dateStr}`);
                }).catch(err => {
                    alert('Archive failed: ' + err.message);
                });
            },

            viewArchive(date) {
                this.isArchiveView = true;
                this.currentArchiveDate = date;
                
                document.getElementById('archiveBanner').classList.add('show');
                document.getElementById('archiveDate').textContent = date;
                document.getElementById('viewModeSubtitle').textContent = 'Archive View (Read Only)';
                document.getElementById('historyModal').style.display = 'none';
                
                // Hide input panels in archive view
                document.getElementById('inputSection').style.display = 'none';
                document.getElementById('techPanel').style.display = 'none';
                
                this.loadData();
            },

            returnToCurrent() {
                this.isArchiveView = false;
                this.currentArchiveDate = null;
                
                document.getElementById('archiveBanner').classList.remove('show');
                document.getElementById('viewModeSubtitle').textContent = 'Live Status Monitoring';
                
                // Restaurar paneles segÃºn rol
                if (this.userRole === 'manager') {
                    document.getElementById('inputSection').style.display = 'block';
                    document.getElementById('techPanel').style.display = 'none';
                } else {
                    document.getElementById('inputSection').style.display = 'none';
                    document.getElementById('techPanel').style.display = 'block';
                }
                
                this.loadData();
            },

            closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            },

            // DATA OPERATIONS
            addVinBulk() {
                // Solo manager puede agregar VINs
                if (this.userRole !== 'manager') {
                    alert('Only managers can add VINs');
                    return;
                }
                if (this.isArchiveView) return;
                if (!this.isOnline) {
                    alert('You are offline');
                    return;
                }

                const textarea = document.getElementById('batchVins');
                const input = textarea.value.trim();
                if (!input) return;

                const vins = input.split(/[\r?\n,]+/).map(v => v.trim()).filter(v => v);
                
                vins.forEach(vin => {
                    const upperVin = vin.toUpperCase();
                    currentRef.push().set({
                        vin: upperVin,
                        machine: this.detectMachine(upperVin),
                        serial: this.detectSerial(upperVin),
                        statusParking: 'Pending',
                        parkingUpdateDate: '',
                        statusKeen: 'Not received',
                        keenDate: '',
                        comments: '',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        createdBy: this.currentUser
                    });
                });
                
                textarea.value = '';
                this.showToast(`Added ${vins.length} VINs`);
            },

            updateStatus(firebaseId, type, value) {
                // CORREGIDO: Permitir a manager Y tech, excepto en vista de archivo
                if (this.isArchiveView) return;
                
                const updates = {};
                const now = new Date().toLocaleString();
                
                if (type === 'parking') {
                    updates.statusParking = value;
                    updates.parkingUpdateDate = (value === 'Sent' || value === 'Not Found') ? now : '';
                } else if (type === 'keen') {
                    updates.statusKeen = value;
                    updates.keenDate = value === 'Received' ? now : '';
                }

                currentRef.child(firebaseId).update(updates);
            },

            updateComment(firebaseId, value) {
                // CORREGIDO: Permitir a manager Y tech, excepto en vista de archivo
                if (this.isArchiveView) return;
                
                currentRef.child(firebaseId).update({
                    comments: value,
                    lastModified: firebase.database.ServerValue.TIMESTAMP,
                    modifiedBy: this.currentUser
                });
            },

            detectMachine(vin) {
                if (vin.includes("FL")) return "255";
                if (vin.includes("ZE")) return "275X";
                if (vin.includes("R8")) return "275";
                if (vin.includes("KR")) return "265";
                if (vin.includes("2X")) return "285";
                if (vin.includes("P9")) return "285";
                return "";
            },

            detectSerial(vin) {
                const match = vin.match(/(FL|ZE|R8|KR|2X|P9)(\d+)/i);
                return match ? match[1] + match[2] : "";
            },

            // UTILITIES
            forceSync() {
                if (database) {
                    database.goOnline();
                    this.loadData();
                }
            },

            showToast(msg) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
                    background: rgba(30,41,59,0.95); color: white; padding: 12px 24px;
                    border-radius: 25px; border: 1px solid rgba(255,255,255,0.2);
                    z-index: 10000; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                toast.textContent = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            },

            generateReport() {
                // Simplified chart report
                const stats = {
                    total: this.data.length,
                    received: this.data.filter(r => r.statusKeen === 'Received').length,
                    pending: this.data.filter(r => r.statusParking === 'Pending').length,
                    sent: this.data.filter(r => r.statusParking === 'Sent').length,
                    notfound: this.data.filter(r => r.statusParking === 'Not Found').length
                };
                alert(`Report:\nTotal: ${stats.total}\nReceived: ${stats.received}\nPending: ${stats.pending}\nSent: ${stats.sent}\nNot Found: ${stats.notfound}`);
            },

            exportExcel(isBackup = false) {
                if (this.data.length === 0) return;
                const rows = this.data.map(r => [
                    r.vin, r.machine, r.serial, r.statusParking, r.parkingUpdateDate || '',
                    r.statusKeen, r.keenDate || '', r.comments
                ]);
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([
                    ['VIN', 'Machine', 'Serial', 'Parking', 'Update', 'Keen', 'Date', 'Comments'],
                    ...rows
                ]);
                XLSX.utils.book_append_sheet(wb, ws, "Report");
                const filename = isBackup 
                    ? `BACKUP_${new Date().toISOString().split('T')[0]}`
                    : `Keen_Report_${new Date().toISOString().split('T')[0]}`;
                XLSX.writeFile(wb, `${filename}.xlsx`);
            },

            exportPDF() {
                if (this.data.length === 0) return alert('No data');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                doc.text("Keen Daily Report", 14, 20);
                doc.autoTable({
                    head: [['VIN', 'Machine', 'Parking', 'Update', 'Keen', 'Date', 'Comments']],
                    body: this.data.map(r => [
                        r.vin, r.machine, r.statusParking || 'Pending', r.parkingUpdateDate || '-',
                        r.statusKeen || 'Not received', r.keenDate || '-', r.comments || '-'
                    ]),
                    startY: 30, styles: { fontSize: 9 }
                });
                doc.save(`Keen_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            }
        };

        window.onload = () => app.init();
        
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>